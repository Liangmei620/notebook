<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>ä¸­æ–‡è®°äº‹æœ¬</title>

  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    /* å°†æ‚¨çš„è‡ªå®šä¹‰ CSS æ”¾åœ¨è¿™é‡Œï¼Œæˆ–è€…å°†å…¶å‰ªåˆ‡åˆ° style.css æ–‡ä»¶ä¸­ */
    body {
      font-family: "Microsoft YaHei", sans-serif;
      margin: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    h1 {
      color: #4CAF50;
      text-align: center;
      margin-bottom: 20px;
    }
    #editor-container {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      padding: 15px;
    }
    #toolbar {
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 10px;
      background-color: #f7f7f7; /* å·¥å…·æ èƒŒæ™¯è‰² */
      border-radius: 5px 5px 0 0;
      padding: 8px;
    }
    #editor {
      height: 400px; /* è°ƒæ•´ç¼–è¾‘å™¨é«˜åº¦ */
      border: 1px solid #eee;
      background-color: #fff;
      border-radius: 0 0 8px 8px;
      padding: 10px;
    }
    .ql-editor {
      min-height: 380px; /* ç¡®ä¿ç¼–è¾‘å™¨å†…å®¹åŒºæœ‰æœ€å°é«˜åº¦ */
    }
    #exportBtn {
      display: block; /* æŒ‰é’®ç‹¬å ä¸€è¡Œ */
      width: 150px;
      margin: 20px auto; /* å±…ä¸­æ˜¾ç¤º */
      padding: 12px 20px;
      background-color: #2196f3;
      color: white;
      border: none;
      border-radius: 8px; /* æ›´åœ†æ¶¦çš„æŒ‰é’® */
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #exportBtn:hover {
      background-color: #1976d2;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body>
  <h1>ä¸­æ–‡è®°äº‹æœ¬ / Notebook</h1>

  <div id="editor-container">
    <div id="toolbar">
      <span class="ql-formats">
        <button class="ql-bold"></button>
        <button class="ql-italic"></button>
        <button class="ql-underline"></button>
        <button class="ql-strike"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-header" value="1"></button>
        <button class="ql-header" value="2"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
      </span>
      <span class="ql-formats">
        <select class="ql-color"></select>
        <select class="ql-background"></select>
      </span>
      <span class="ql-formats">
        <select class="ql-align"></select>
      </span>
      <span class="ql-formats">
        <button class="ql-image"></button>
        <button class="ql-link"></button>
      </span>
      <span class="ql-formats">
        <button class="ql-clean"></button>
      </span>
    </div>
    <div id="editor"></div>
  </div>

  <button id="exportBtn">ğŸ“„ å¯¼å‡ºä¸º PDF</button>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // å¯¼å…¥ Quill æ¨¡å—
const Clipboard = Quill.import('modules/clipboard');
const Delta = Quill.import('delta');

// å®šä¹‰è‡ªå®šä¹‰å‰ªè´´æ¿ç±»
class CustomClipboard extends Clipboard {
  async onPaste(e) {
    // é˜»æ­¢é»˜è®¤çš„ç²˜è´´è¡Œä¸º
    e.preventDefault();

    // è·å–å‰ªè´´æ¿ä¸­çš„ HTML å’Œçº¯æ–‡æœ¬å†…å®¹
    const html = e.clipboardData.getData('text/html');
    const text = e.clipboardData.getData('text/plain');
    let container = document.createElement('div'); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨

    // æ ¹æ®æ˜¯å¦æœ‰ HTML å†…å®¹æ¥è®¾ç½®å®¹å™¨çš„å†…éƒ¨
    if (html) {
      container.innerHTML = html;
    } else {
      container.textContent = text;
    }

    // åªæ›¿æ¢ 'the ... solid-state' ä¸­çš„æ‰€æœ‰ '$'
    // åˆ›å»ºä¸€ä¸ª TreeWalker æ¥éå†å®¹å™¨ä¸­çš„æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
    const walker = document.createTreeWalker(
      container,
      NodeFilter.SHOW_TEXT, // åªæ˜¾ç¤ºæ–‡æœ¬èŠ‚ç‚¹
      null, // ä¸ä½¿ç”¨è¿‡æ»¤å™¨å‡½æ•°
      false // ä¸å±•å¼€å®ä½“å¼•ç”¨
    );

    // éå†æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
    while (walker.nextNode()) {
      let node = walker.currentNode;
      // ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾æ‰€æœ‰ 'the ... solid-state' ç‰‡æ®µ
      node.nodeValue = node.nodeValue.replace(/(the[\s\S]*?solid-state)/gi, (match) => {
        // åœ¨åŒ¹é…åˆ°çš„ç‰‡æ®µä¸­ï¼Œå°†æ‰€æœ‰ '$' æ›¿æ¢ä¸º '87Rb'
        return match.replace(/\$/g, '87Rb');
      });
    }

    // å°†å¤„ç†åçš„ HTML å†…å®¹è½¬æ¢ä¸º Quill çš„ Delta æ ¼å¼
    const delta = this.convert(container.innerHTML);
    // è·å–å½“å‰ç¼–è¾‘å™¨çš„é€‰åŒº
    const range = this.quill.getSelection(true);

    // æ›´æ–°ç¼–è¾‘å™¨å†…å®¹ï¼Œæ’å…¥æˆ–æ›¿æ¢ç²˜è´´çš„å†…å®¹
    this.quill.updateContents(
      new Delta().retain(range.index).concat(delta),
      'user' // æ ‡è¯†ä¸ºç”¨æˆ·æ“ä½œ
    );

    // ç§»åŠ¨é€‰åŒºåˆ°ç²˜è´´å†…å®¹çš„æœ«å°¾
    this.quill.setSelection(range.index + delta.length(), 0, 'silent');
  }
}

// æ³¨å†Œè‡ªå®šä¹‰å‰ªè´´æ¿æ¨¡å—
// ç¬¬ä¸‰ä¸ªå‚æ•° `true` è¡¨ç¤ºå¼ºåˆ¶è¦†ç›– Quill å†…ç½®çš„å‰ªè´´æ¿æ¨¡å—
Quill.register('modules/clipboard', CustomClipboard, true);

// åˆå§‹åŒ– Quill ç¼–è¾‘å™¨
// æ³¨æ„ï¼šç°åœ¨ Quill çš„ modules é…ç½®ä¸­éœ€è¦åŒ…å« `clipboard: true`
const quill = new Quill('#editor', {
  theme: 'snow', // ä½¿ç”¨ 'snow' ä¸»é¢˜ï¼Œä¸æ‚¨çš„æ ·å¼è¡¨å¯¹åº”
  modules: {
    toolbar: '#toolbar', // æŒ‡å®šå·¥å…·æ çš„ ID
    clipboard: true // å¯ç”¨å‰ªè´´æ¿æ¨¡å—ï¼ˆè¿™é‡Œä¼šä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ CustomClipboardï¼‰
  },
  placeholder: 'å¼€å§‹æ‚¨çš„ç¬”è®°...', // æ·»åŠ ä¸€ä¸ªå ä½ç¬¦æ–‡æœ¬
});

// è®¾ç½®ç¼–è¾‘å™¨çš„åˆå§‹å†…å®¹
quill.root.innerHTML = '<p>æ¬¢è¿ä½¿ç”¨æ–‡æœ¬æ¡†ï¼</p>';

// è·å–å¯¼å‡ºæŒ‰é’®å…ƒç´ 
const exportBtn = document.getElementById('exportBtn');

// ä¸ºå¯¼å‡ºæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
exportBtn.addEventListener('click', async () => {
  // ä» window å¯¹è±¡ä¸­è§£æ„å‡º jsPDF æ„é€ å‡½æ•°
  const { jsPDF } = window.jspdf;
  // åˆ›å»ºä¸€ä¸ªæ–°çš„ jsPDF å®ä¾‹
  const doc = new jsPDF();

  // ä½¿ç”¨ html2canvas å°†ç¼–è¾‘å™¨çš„å†…å®¹æ¸²æŸ“ä¸º Canvas
  await html2canvas(document.querySelector(".ql-editor"), {
    scale: 2, // æé«˜æ¸²æŸ“åˆ†è¾¨ç‡ï¼Œä½¿å¯¼å‡ºçš„PDFæ›´æ¸…æ™°
    useCORS: true, // å¦‚æœç¼–è¾‘å™¨ä¸­åŒ…å«æ¥è‡ªä¸åŒæºçš„å›¾ç‰‡ï¼Œå¯èƒ½éœ€è¦æ­¤é¡¹
  }).then(canvas => {
    // å°† Canvas è½¬æ¢ä¸º PNG æ ¼å¼çš„æ•°æ® URL
    const imgData = canvas.toDataURL("image/png");
    // è·å–å›¾åƒçš„å±æ€§ï¼Œä»¥ä¾¿è®¡ç®—åœ¨PDFä¸­çš„å°ºå¯¸
    const imgProps = doc.getImageProperties(imgData);
    // è·å– PDF é¡µé¢çš„å®½åº¦
    const pdfWidth = doc.internal.pageSize.getWidth();
    // è®¡ç®—åœ¨ PDF ä¸­å›¾åƒçš„é«˜åº¦ï¼Œä¿æŒå®½é«˜æ¯”
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    
    // å°†å›¾åƒæ·»åŠ åˆ° PDF
    // å‚æ•°ï¼šå›¾åƒæ•°æ®, å›¾åƒç±»å‹, xåæ ‡, yåæ ‡, å®½åº¦, é«˜åº¦
    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    
    // ä¿å­˜ PDF æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º "note.pdf"
    doc.save("note.pdf");
  });
});
  </script>
</body>
</html>
